# Level Pipeline Implementation Plan

Implement the new level generation pipeline, starting with level 3 as the test case.

## Phase 1: Create Lore JSON for Level 3

**Goal**: Extract narrative content from existing files into the new JSON format.

1. Read `levels/level03/meta.vim` to get: title, description, objective, quote, victory_quote
2. Read `levels/level03/lore.txt` to get: lore text
3. Create `levels/lore/level03.json` with all narrative fields
4. Verify JSON is valid

**Files created**:
- `levels/lore/level03.json`

---

## Phase 2: Update level_builder.py

**Goal**: Generate `meta.vim` from YAML + lore JSON, add manifest generation.

### 2a: Add meta.vim generation

1. Add function to read lore JSON file
2. Add function to generate meta.vim content:
   - Read dimensions, start, exit from YAML
   - Read commands, blocked_categories, features from YAML
   - Read title, description, objective, quote, victory_quote, lore from JSON
   - Merge into Vim dictionary format
   - Handle `v:null` for null values
   - Handle multiline strings (escape properly for Vim)
3. Update `main()` to write meta.vim alongside maze.txt and spies.vim
4. Add "Generated by level_builder.py" header comment to meta.vim

### 2b: Add manifest generation

1. Add `--all` flag to argument parser
2. Add function to scan all `levels/*/level.yaml` files
3. For each level:
   - Read id from YAML
   - Read title from corresponding lore JSON
   - Build manifest entry: `{'id': X, 'dir': 'levelXX', 'title': '...'}`
4. Write `levels/manifest.vim`

### 2c: Update YAML schema

1. Add `id` field to level.yaml (required)
2. Add `features` field to level.yaml (optional, defaults to [])
3. Viewport defaults to maze dimensions if not specified

**Files modified**:
- `tools/level_builder.py`
- `levels/level03/level.yaml` (add id, features fields)

---

## Phase 3: Update Level_Load for Features

**Goal**: Replace logic.vim sourcing with feature-based setup.

1. In `levels/api/level.vim`, find the logic.vim sourcing block (around line 95-99)
2. Replace with feature detection:
   ```vim
   let l:features = get(s:current_meta, 'features', [])
   if index(l:features, 'spies') >= 0
     call Collision_SetSpyCallback({-> Game_LevelFailed()})
   endif
   ```
3. Remove logic.vim sourcing entirely

**Files modified**:
- `levels/api/level.vim`

---

## Phase 4: Update Lore Screen

**Goal**: Read lore from meta.vim instead of separate lore.txt file.

1. In `game/ui/lore.vim`, find the lore.txt reading block (around line 62-70)
2. Change to read from meta instead:
   ```vim
   let l:lore_text = get(Game_GetLevelMeta(), 'lore', '')
   if !empty(l:lore_text)
     for l:line in split(l:lore_text, '\n')
       call add(l:lines, '    ' . l:line)
     endfor
   else
     call add(l:lines, '    [Lore text not found]')
   endif
   ```

**Files modified**:
- `game/ui/lore.vim`

---

## Phase 5: Create Test Script

**Goal**: Replace per-level init.vim with a single test script.

1. Create `tools/test_level.sh`:
   ```bash
   #!/bin/bash
   # Test a level standalone (bypasses game UI)
   LEVEL="${1:-level01}"
   ./src/vim --clean -c "source levels/api/level.vim" -c "call Level_Load('levels/$LEVEL')"
   ```
2. Make executable: `chmod +x tools/test_level.sh`

**Files created**:
- `tools/test_level.sh`

---

## Phase 6: Build and Verify Level 3

**Goal**: Generate all files and verify the game works.

1. Run: `python3 tools/level_builder.py levels/level03`
   - Should generate: maze.txt, meta.vim, spies.vim
2. Run: `python3 tools/level_builder.py --all`
   - Should generate: manifest.vim
3. Run: `python3 tools/validate_levels.py levels/level03`
   - Should pass validation
4. Test standalone: `./tools/test_level.sh level03`
   - Verify maze loads, spies move, collision works
5. Test full game: `./play.sh`
   - Navigate to level 3, verify lore screen shows correctly
   - Play level, verify victory/defeat work

---

## Phase 7: Clean Up Level 3

**Goal**: Remove obsolete files after verifying everything works.

1. Delete `levels/level03/init.vim`
2. Delete `levels/level03/logic.vim`
3. Delete `levels/level03/lore.txt`
4. Verify game still works

**Files deleted**:
- `levels/level03/init.vim`
- `levels/level03/logic.vim`
- `levels/level03/lore.txt`

---

## Phase 8: Backport Levels 1 and 2 (Later)

**Goal**: Migrate remaining levels to the new pipeline.

For each level (1, then 2):

1. Create `levels/lore/levelXX.json` from existing meta.vim + lore.txt
2. Create `levels/levelXX/level.yaml`:
   - Reverse-engineer walls from maze.txt (or keep maze.txt as-is and skip wall definitions)
   - Copy other fields from meta.vim
3. Regenerate with level_builder.py
4. Verify game works
5. Delete obsolete files (init.vim, lore.txt)

**Note**: For levels without complex geometry, we might manually create simple YAML or just keep the existing maze.txt and only generate meta.vim. The builder could have a `--maze-only=false` flag to skip maze generation.

---

## File Change Summary

### New Files
- `levels/lore/level03.json`
- `tools/test_level.sh`

### Modified Files
- `tools/level_builder.py` (major changes)
- `levels/level03/level.yaml` (add id, features)
- `levels/api/level.vim` (feature handling)
- `game/ui/lore.vim` (read lore from meta)

### Regenerated Files
- `levels/level03/maze.txt`
- `levels/level03/meta.vim`
- `levels/level03/spies.vim`
- `levels/manifest.vim`

### Deleted Files (after verification)
- `levels/level03/init.vim`
- `levels/level03/logic.vim`
- `levels/level03/lore.txt`

---

## Rollback Plan

If something breaks:
1. Generated files are in git, so `git checkout levels/level03/` restores them
2. Keep old logic.vim/lore.txt until fully verified
3. The Vim code changes are backward compatible (features defaults to [], lore falls back gracefully)
